<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="'Room: ' + ${room.name} + ' - Sync Watch'"></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .video-container {
            position: relative;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
        }

        .video-player {
            width: 100%;
            height: auto;
            min-height: 400px;
        }

        .controls-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.7));
            padding: 20px;
            color: white;
        }

        .user-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .user-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(45deg, #007bff, #6610f2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            margin-right: 10px;
        }

        .host-badge {
            background: #ffc107;
            color: #000;
        }

        .sync-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
        }

        .sidebar {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            display: none;
        }

        .episode-controls {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .episode-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 6px;
        }

        .episode-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .episode-item:hover {
            background-color: #f8f9fa;
        }

        .episode-item.active {
            background-color: #007bff;
            color: white;
        }

        .episode-item:last-child {
            border-bottom: none;
        }

        .content-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body class="bg-light">
<nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
        <div>
            <a href="/" class="navbar-brand">
                <i class="fas fa-arrow-left me-2"></i>Sync Watch
            </a>
            <span class="text-light">/ <span th:text="${room.name}"></span></span>
        </div>
        <div class="d-flex align-items-center">
            <div class="user-avatar me-2" th:text="${currentUser.username.substring(0,1).toUpperCase()}"></div>
            <span class="text-white" th:text="${currentUser.username}"></span>
            <span th:if="${isHost}" class="badge bg-warning text-dark ms-2">Host</span>
        </div>
    </div>
</nav>

<div class="container-fluid mt-3">
    <div class="row">
        <div class="col-lg-9">
            <div class="video-container mb-3">
                <video
                        id="videoPlayer"
                        class="video-player"
                        controls
                        preload="metadata"
                        th:src="${streamUrl}">
                    Your browser does not support video.
                </video>

                <div class="loading-indicator" id="loadingIndicator">
                    <i class="fas fa-spinner fa-spin me-2"></i>Loading...
                </div>

                <div class="sync-indicator" id="syncIndicator">
                    <i class="fas fa-sync-alt"></i> Synchronized
                </div>
            </div>

            <div class="content-info">
                <h5 class="mb-3">
                    <i class="fas fa-film me-2" th:if="${room.roomType.name() == 'MOVIE'}"></i>
                    <i class="fas fa-tv me-2" th:if="${room.roomType.name() == 'SERIES'}"></i>
                    <span th:text="${room.contentTitle}"></span>
                </h5>

                <div class="row">
                    <div class="col-md-6">
                        <div th:if="${room.roomType.name() == 'MOVIE'}">
                            <p class="mb-1">
                                <i class="fas fa-clock me-2"></i>
                                Duration: <span th:text="${room.movie.formattedDuration}"></span>
                            </p>
                            <p class="mb-1" th:if="${room.movie.year}">
                                <i class="fas fa-calendar me-2"></i>
                                Year: <span th:text="${room.movie.year}"></span>
                            </p>
                        </div>

                        <div th:if="${room.roomType.name() == 'SERIES'}">
                            <p class="mb-1">
                                <i class="fas fa-tv me-2"></i>
                                Series: <span th:text="${room.series.title}"></span>
                            </p>
                            <p class="mb-1" th:if="${room.currentEpisode}">
                                <i class="fas fa-play-circle me-2"></i>
                                Current: S<span th:text="${room.currentEpisode.seasonNumber}"></span>E<span th:text="${room.currentEpisode.episodeNumber}"></span>
                                - <span th:text="${room.currentEpisode.episodeTitle}"></span>
                            </p>
                            <p class="mb-1" th:if="${room.currentEpisode and room.currentEpisode.duration}">
                                <i class="fas fa-clock me-2"></i>
                                Duration: <span th:text="${room.currentEpisode.formattedDuration}"></span>
                            </p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-1">
                            <i class="fas fa-users me-2"></i>
                            Viewers: <span id="userCount" th:text="${room.userCount}"></span>
                        </p>
                        <p class="mb-1">
                            <i class="fas fa-door-open me-2"></i>
                            Room ID: <code th:text="${room.id}"></code>
                        </p>
                        <p class="mb-1">
                            <i class="fas fa-tag me-2"></i>
                            Type: <span class="badge bg-info" th:text="${room.roomType.name().toLowerCase()}"></span>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3">
            <div class="sidebar">
                <div th:if="${room.roomType.name() == 'SERIES' and isHost}" class="episode-controls">
                    <h6 class="mb-3">
                        <i class="fas fa-cog me-2"></i>
                        Episode Controls
                    </h6>

                    <div class="d-grid gap-2 mb-3">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="previousEpisode()">
                            <i class="fas fa-step-backward me-1"></i>Previous Episode
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="nextEpisode()">
                            <i class="fas fa-step-forward me-1"></i>Next Episode
                        </button>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small">Quick Jump:</label>
                        <div class="episode-list" id="episodeList" th:if="${availableEpisodes}">
                            <div class="episode-item"
                                 th:each="episode : ${availableEpisodes}"
                                 th:attr="data-episode-id=${episode.id}"
                                 th:classappend="${room.currentEpisodeId == episode.id} ? 'active' : ''"
                                 onclick="switchToEpisode(this)">
                                <div class="fw-bold">S<span th:text="${episode.seasonNumber}"></span>E<span th:text="${episode.episodeNumber}"></span></div>
                                <div class="small text-muted" th:text="${episode.episodeTitle}"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-3">
                    <h6 class="mb-3">
                        <i class="fas fa-users me-2"></i>
                        Users in Room
                    </h6>

                    <div class="user-list" id="userList">
                    </div>

                    <hr>

                    <div class="d-grid gap-2">
                        <form th:action="@{'/leave-room/' + ${room.id}}" method="post">
                            <button type="submit" class="btn btn-outline-danger w-100">
                                <i class="fas fa-sign-out-alt me-2"></i>Leave Room
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@6/bundles/stomp.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script th:inline="javascript">
    const roomId = [[${room.id}]];
    const currentUserId = [[${currentUser.id}]];
    const currentUsername = [[${currentUser.username}]];
    const isHost = [[${isHost}]];
    const roomType = [[${room.roomType.name()}]];
    const currentEpisodeId = [[${room.currentEpisodeId}]] || 0;

    let stompClient = null;
    let isConnected = false;
    let isSeeking = false;
    let isSyncAction = false;
    let lastSyncTime = 0;
    let debounceTimeout = null;

    const video = document.getElementById('videoPlayer');
    const syncIndicator = document.getElementById('syncIndicator');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const userList = document.getElementById('userList');
    const userCount = document.getElementById('userCount');

    video.preload = 'metadata';

    video.addEventListener('loadstart', () => {
        loadingIndicator.style.display = 'block';
    });

    video.addEventListener('canplay', () => {
        loadingIndicator.style.display = 'none';
    });

    video.addEventListener('waiting', () => {
        loadingIndicator.style.display = 'block';
    });

    video.addEventListener('playing', () => {
        loadingIndicator.style.display = 'none';
    });

    function connect() {
        const socket = new SockJS('/ws');
        stompClient = new StompJs.Client({
            webSocketFactory: () => socket,
            debug: function (str) {
                console.log('STOMP: ' + str);
            },
            onConnect: function (frame) {
                console.log('Connected: ' + frame);
                isConnected = true;
                subscribeToRoom();
                joinRoom();
            },
            onDisconnect: function () {
                console.log('Disconnected');
                isConnected = false;
            }
        });

        stompClient.activate();
    }

    function subscribeToRoom() {
        stompClient.subscribe('/topic/room/' + roomId + '/sync', function (message) {
            const data = JSON.parse(message.body);
            handleSyncMessage(data);
        });

        stompClient.subscribe('/topic/room/' + roomId + '/users', function (message) {
            const users = JSON.parse(message.body);
            updateUserList(users);
        });

        stompClient.subscribe('/user/queue/room/' + roomId + '/state', function (message) {
            const state = JSON.parse(message.body);
            syncVideoState(state);
        });

        if (roomType === 'SERIES') {
            stompClient.subscribe('/topic/room/' + roomId + '/episodeChanged', function (message) {
                const data = JSON.parse(message.body);
                handleEpisodeChange(data);
            });
        }
    }

    function joinRoom() {
        if (isConnected) {
            stompClient.publish({
                destination: '/app/room/' + roomId + '/join',
                body: JSON.stringify({
                    userId: currentUserId,
                    username: currentUsername
                })
            });
        }
    }

    function handleSyncMessage(data) {
        if (data.userId === currentUserId) return;

        console.log('Sync message:', data.action, 'time:', data.currentTime);

        isSyncAction = true;

        if (debounceTimeout) {
            clearTimeout(debounceTimeout);
        }

        switch (data.action) {
            case 'play':
                if (Math.abs(video.currentTime - data.currentTime) > 2) {
                    video.currentTime = data.currentTime;
                }
                video.play().catch(e => console.log('Play failed:', e));
                showSyncIndicator('Playing');
                break;

            case 'pause':
                video.currentTime = data.currentTime;
                video.pause();
                showSyncIndicator('Paused');
                break;

            case 'seek':
                video.currentTime = data.currentTime;
                showSyncIndicator('Seeking');
                break;
        }

        setTimeout(() => {
            updateCurrentUserTime();
        }, 100);

        debounceTimeout = setTimeout(() => {
            isSyncAction = false;
        }, 500);
    }

    function handleEpisodeChange(data) {
        console.log('Episode change:', data);

        if (data.userId === currentUserId) return;

        if (data.streamUrl) {
            video.src = data.streamUrl;
            video.currentTime = 0;
            video.pause();

            showSyncIndicator('Episode Changed');

            updateEpisodeList(data.episodeId);

            setTimeout(() => {
                location.reload();
            }, 1000);
        }
    }

    function updateCurrentUserTime() {
        if (isConnected && !video.paused) {
            stompClient.publish({
                destination: '/app/room/' + roomId + '/timeUpdate',
                body: JSON.stringify({
                    userId: currentUserId,
                    currentTime: video.currentTime
                })
            });
        }
    }

    function syncVideoState(state) {
        console.log('Syncing video state:', state);
        isSyncAction = true;

        if (state.streamUrl && video.src !== state.streamUrl) {
            video.src = state.streamUrl;
        }

        video.currentTime = state.currentTime;
        if (state.isPlaying) {
            video.play().catch(e => console.log('Play failed:', e));
        } else {
            video.pause();
        }

        updateCurrentUserTime();

        setTimeout(() => {
            isSyncAction = false;
        }, 500);
    }

    function showSyncIndicator(action) {
        syncIndicator.innerHTML = `<i class="fas fa-sync-alt fa-spin"></i> ${action}`;
        syncIndicator.style.background = 'rgba(0,123,255,0.8)';

        setTimeout(() => {
            syncIndicator.innerHTML = '<i class="fas fa-sync-alt"></i> Synchronized';
            syncIndicator.style.background = 'rgba(0,0,0,0.7)';
        }, 2000);
    }

    function updateUserList(users) {
        userList.innerHTML = '';
        userCount.textContent = users.length;

        users.forEach(user => {
            const userDiv = document.createElement('div');
            userDiv.className = 'user-item';

            const isCurrentUser = user.id === currentUserId;
            const isHostUser = user.id === [[${room.hostId}]];

            userDiv.innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="user-avatar ${isHostUser ? 'host-badge' : ''}">${user.username.charAt(0).toUpperCase()}</div>
                    <div>
                        <div class="fw-bold">${user.username} ${isCurrentUser ? '(You)' : ''}</div>
                        <small class="text-muted">${user.formattedCurrentTime || '0:00'}</small>
                    </div>
                </div>
                ${isHostUser ? '<span class="badge bg-warning text-dark">Host</span>' : ''}
            `;

            userList.appendChild(userDiv);
        });
    }

    function switchToEpisode(episodeElement) {
        if (!isHost) {
            alert('Only the host can change episodes');
            return;
        }

        const episodeId = parseInt(episodeElement.getAttribute('data-episode-id'));

        if (isConnected) {
            stompClient.publish({
                destination: '/app/room/' + roomId + '/switchEpisode',
                body: JSON.stringify({
                    userId: currentUserId,
                    episodeId: episodeId
                })
            });
        }
    }

    function nextEpisode() {
        if (!isHost) {
            alert('Only the host can change episodes');
            return;
        }

        if (isConnected) {
            stompClient.publish({
                destination: '/app/room/' + roomId + '/nextEpisode',
                body: JSON.stringify({
                    userId: currentUserId
                })
            });
        }
    }

    function previousEpisode() {
        if (!isHost) {
            alert('Only the host can change episodes');
            return;
        }

        if (isConnected) {
            stompClient.publish({
                destination: '/app/room/' + roomId + '/previousEpisode',
                body: JSON.stringify({
                    userId: currentUserId
                })
            });
        }
    }

    function updateEpisodeList(activeEpisodeId) {
        const episodeItems = document.querySelectorAll('.episode-item');
        episodeItems.forEach(item => {
            const episodeId = parseInt(item.getAttribute('data-episode-id'));
            if (episodeId === activeEpisodeId) {
                item.classList.add('active');
            } else {
                item.classList.remove('active');
            }
        });
    }

    video.addEventListener('play', function() {
        if (isConnected && !isSyncAction) {
            console.log('User initiated play');
            sendMessage('play', video.currentTime);
        }
    });

    video.addEventListener('pause', function() {
        if (isConnected && !isSyncAction) {
            console.log('User initiated pause');
            sendMessage('pause', video.currentTime);
        }
    });

    video.addEventListener('seeking', function() {
        isSeeking = true;
    });

    video.addEventListener('seeked', function() {
        isSeeking = false;
        if (isConnected && !isSyncAction) {
            console.log('User initiated seek to', video.currentTime);
            sendMessage('seek', video.currentTime);
        }
    });

    function sendMessage(action, currentTime) {
        if (debounceTimeout) {
            clearTimeout(debounceTimeout);
        }

        debounceTimeout = setTimeout(() => {
            stompClient.publish({
                destination: '/app/room/' + roomId + '/' + action,
                body: JSON.stringify({
                    userId: currentUserId,
                    currentTime: currentTime
                })
            });

            updateCurrentUserTime();
        }, 100);
    }

    setInterval(() => {
        if (isConnected && !video.paused) {
            updateCurrentUserTime();
        }
    }, 2000);

    window.addEventListener('beforeunload', function() {
        if (isConnected) {
            stompClient.publish({
                destination: '/app/room/' + roomId + '/leave',
                body: JSON.stringify({
                    userId: currentUserId
                })
            });
        }
    });

    connect();
</script>
</body>
</html>
